<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Label Interpolation + Fade</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label>Scale:
      <input type="range" min="8" max="9" step="0.01" id="scaleSlider" value="8.0" />
      <span id="scaleValue">8.00</span>
    </label>
  </div>

  <script>
    // MOCKED DATA (simulating a DB response)
    const mockedLabelData = [
      {
        label_trace_id: '1',
        text: 'Martinus Nijhofflaan',
        fontSize: 16,
        feature_class: 'road',
        steps: [
          { step_value: 8.0, anchor: [300, 250], angle: 0, fits: false },
          { step_value: 9.0, anchor: [500, 300], angle: 30, fits: true }
        ]
      },
      {
        label_trace_id: '2',
        text: 'Hendrik Marsmanlaan',
        fontSize: 16,
        feature_class: 'road',
        steps: [
          { step_value: 8.0, anchor: [350, 450], angle: 0, fits: true },
          { step_value: 9.0, anchor: [600, 400], angle: -15, fits: false }
        ]
      }
    ];

    // PixiJS setup
    const app = new PIXI.Application({
      width: window.innerWidth,
      height: window.innerHeight,
      backgroundColor: 0xffffff
    });
    document.body.appendChild(app.view);

    const labelObjects = {};
    const debugDots = {};
    let globalLabels = [];

    function initLabels(data) {
      globalLabels = data;

      globalLabels.forEach(label => {
        const text = new PIXI.Text(label.text, {
          fontFamily: 'Arial',
          fontSize: label.fontSize,
          fill: 0x000000
        });
        text.anchor.set(0.5);
        app.stage.addChild(text);
        labelObjects[label.label_trace_id] = text;

        const dot = new PIXI.Graphics();
        dot.beginFill(0xff0000);
        dot.drawCircle(0, 0, 4);
        dot.endFill();
        app.stage.addChild(dot);
        debugDots[label.label_trace_id] = dot;
      });
    }

    function interpolate(label, scale) {
      const steps = label.steps;
      for (let i = 0; i < steps.length - 1; i++) {
        const s0 = steps[i];
        const s1 = steps[i + 1];
        if (scale >= s0.step_value && scale <= s1.step_value) {
          const t = (scale - s0.step_value) / (s1.step_value - s0.step_value);
          const x = (1 - t) * s0.anchor[0] + t * s1.anchor[0];
          const y = (1 - t) * s0.anchor[1] + t * s1.anchor[1];
          const angle = (1 - t) * s0.angle + t * s1.angle;

          // Fade logic based on fits
          let alpha = 1;
          if (!s0.fits && !s1.fits) alpha = 0;
          else if (!s0.fits) alpha = t;
          else if (!s1.fits) alpha = 1 - t;

          return { x, y, angle, alpha };
        }
      }
      return null;
    }

    function updateLabels(scale) {
      globalLabels.forEach(label => {
        const interp = interpolate(label, scale);
        const textObj = labelObjects[label.label_trace_id];
        const dotObj = debugDots[label.label_trace_id];

        if (interp) {
          textObj.visible = true;
          dotObj.visible = false;
          textObj.position.set(interp.x, interp.y);
          textObj.rotation = interp.angle * Math.PI / 180;
          textObj.alpha = interp.alpha;

          dotObj.position.set(interp.x, interp.y);
          dotObj.alpha = interp.alpha;
        } else {
          textObj.visible = false;
          dotObj.visible = false;
        }
      });
    }

    // Slider handling
    const slider = document.getElementById('scaleSlider');
    const scaleDisplay = document.getElementById('scaleValue');
    slider.addEventListener('input', () => {
      const scale = parseFloat(slider.value);
      scaleDisplay.textContent = scale.toFixed(2);
      updateLabels(scale);
    });

    // Run it!
    initLabels(mockedLabelData);
    updateLabels(parseFloat(slider.value));
  </script>
</body>
</html>
